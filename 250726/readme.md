# 長期記憶モデルのためのペルソナベース高品質対話データ生成パイプライン

## 1. プロジェクト概要

本プロジェクトは、ユーザーと長期的で一貫した関係を築けるパーソナルエージェントの開発を目的としています。その中核技術として、LLM（大規模言語モデル）に「ユーザーに関する心理学的に重要な情報」を記憶・活用させるための、高品質な教師データセットを生成するパイプラインを構築します。

本パイプラインの最大の特徴は、以下の2つの設計思想に基づいている点です。

1.  **理論駆動型アプローチ**: 何を「重要な情報」と見なすかを、社会心理学の理論（社会的浸透理論、マズローの欲求階層説）に基づき定義しています。
2.  **ペルソナ中心アプローチ**: 生成されるすべての対話データが一貫性を保つよう、まず矛盾のない仮想ユーザー（ペルソナ）を定義し、そのペルソナに基づいて対話を生成します。

## 2. データ生成パイプライン全体像

本パイプラインは、以下の3つの主要なフェーズで構成されています。

1.  **フェーズA: 高品質QAペアの生成**:
   モデルが記憶すべき「事実」の原材料となる、高品質なQAペアを大規模に生成します。
2.  **フェーズB: ペルソナプロファイルの構築**:
   生成したQAペアを、矛盾のない複数のペルソナに割り振り、各ペルソナのクリーンなプロフィールを作成します。
3.  **フェーズC: ペルソナベースの対話生成**:
   各ペルソナのプロフィールに基づき、ユーザーシミュレータとAIアシスタントによる、一貫性のある自然な対話データを生成します。

## 3. 実行手順

### Step 0: 環境設定

1.  **APIキーの設定**:
   * Google Colab環境の場合: `OPENAI-KEY` という名前で、OpenAIのAPIキーをColabのSecretsに保存してください。
   * ローカル環境の場合: `OPENAI_API_KEY` という名前で、環境変数を設定してください。
2.  **必要なライブラリのインストール**:
   ```bash
   pip install openai tqdm
   ```

### Step 1: 【フェーズA】高品質QAペアの生成 (5,000件)

このステップでは、まず対話の元となる「事実」を5,000件生成します。

1.  **スクリプトの実行**:
   * `generate_qa_5000_in_colab.py` を実行します。
   * このスクリプトは、5,000件の生成を100件ずつのバッチに分割し、`batches/` ディレクトリ内に `batch_XXX.json` として自動で保存します。Colabのセッションが中断しても、再実行すれば途中から再開できます。
2.  **バッチファイルの結合**:
   * すべてのバッチ生成が完了したら、`merge_batches.py` を実行します。
   * これにより、`batches/` 内のすべてのファイルが結合され、最終的な成果物 `QA_pairs_5000_final.json` が生成されます。

### Step 2: 【フェーズB】ペルソナプロファイルの構築 (100人分)

次に、5,000件の事実を、100人の矛盾のないペルソナに割り振ります。

1.  **スクリプトの実行**:
   * `create_personas_v4_api.py` を実行します。
   * このスクリプトは `QA_pairs_5000_final.json` を入力とし、APIを呼び出して各ペルソナのクリーンなプロフィール（名前、誕生日、出身地）を抽出します。
2.  **成果物の確認**:
   * `pilot_personas/` ディレクトリ（※本格生成時は`personas/`に変更推奨）に、`persona_001.json` から `persona_100.json` までの100個のファイルが生成されていることを確認します。

### Step 3: 【フェーズC】ペルソナベースの対話生成

最後に、各ペルソナに基づいた対話データを生成します。

1.  **スクリプトの実行**:
   * `generate_dialogue_v7_llm_judge.py` を実行します。
   * このスクリプトは、指定された `persona_id` のプロフィールを読み込み、50ターンの対話を1セット生成します。（※100人分を生成するには、このスクリプトをループで呼び出す簡単な制御スクリプトを追加する必要があります）
2.  **成果物の確認**:
   * `pilot_dialogues/` ディレクトリ（※本格生成時は`dialogues/`に変更推奨）に、対話ファイル `dialogue_pXX.json` と、事実注入の記録である `dialogue_pXX.metadata.json` がペアで生成されていることを確認します。

---
*この文書は、Geminiとの対話を通じて作成されました。*